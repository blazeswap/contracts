# BlazeSwap

BlazeSwap is a decentralized exchange for the Flare network. The core is based on Uniswap V2, with a few changes and the addition of a plugin system to add specific functionalities needed by the Flare networks, in particular regarding the vote delegation to FTSO providers and the FTSO & F-Asset rewards distribution to liquidity providers. The implementation of a plugin system, inspired by the EIP-2535 (Diamonds), was made necessary to add different functionalities to different pairs, while keeping the the generation of the pair addresses deterministic and without exceeding the maximum allowed contract size, even with a high value of optimizer runs. All smart contracts are designed to be immutable, with potentially just one exception to this rule, described later.

## Smart Contracts:

The set of smart contracts of BlazeSwap, that are the target of the audit, comprises:
- BlazeSwapManager (with BlazeSwapMath and BlazeSwapExecutorManager): a contract maintaining the system parameters like trading fees and plugin addresses (extracted from the factory code to reduce the factory contract size)
- BlazeSwapPair: the  contract that is instantiated for each pair that handles the low-level swap logic and the plugin system
- BlazeSwapFactory: the contract that instantiates and initializes each pair, with different plugins based on the token types
- BlazeSwapRouter: the high-level contract that allows to easily perform swaps
- BlazeSwapDelegationPlugin (with BlazeSwapDelegation and BlazeSwapRewardManager): the plugin that records liquidity provider votes and allows to change the FTSO provider delegation
- BlazeSwapFtsoRewardPlugin (with BlazeSwapFtsoReward): the plugin that allows to track, distribute and claim FTSO rewards (it depends on BlazeSwapDelegationPlugin)

## Additional notes:

1) Main changes to Uniswap V2 code:
  - upgrade to solidity 0.8.x (and so checked math)
  - addition of a fee split functionality to split the trading fees generated by a specific router/address between two accounts
  - addition of LP token snapshots, that are used to distribute the rewards to liquidity providers in the correct amounts
  - addition of the plugin system
2) The Delegation and the FtsoReward plugins are added to the Manager contract at deploy time, the possibility that they are not initialized should not be taken into consideration.
   Anyone can trigger the change of the delegated providers (`changeProviders()`), if the passed providers have more votes than the previous set.
   The rewards generated by the liquidity in the pool can be distributed (claimed by the pair to the BlazeSwapRewardManager address) by anyone, using the `distributeFtsoRewards()` function. Each liquidity provider can then withdraw its own share using the `claimFtsoRewards()` function.
3) Given that the F-Asset system and its rewards are not yet finalized, it was made the choice to inititally not allow the creation of pairs that include a F-Asset token. All F-Assets will have an `assetManager()` function that returns the address of the asset manager controller contract, that allows to distinguish them from other ERC20 tokens. Once the F-Asset system will be available, a new plugin will be added via the `setFAssetsRewardPlugin()` function. In the case the F-Assets reward system won't be deployed at the same time, there is the possibility to still create pairs with F-Assets and add the plugin later, using the `setAllowFAssetPairsWithoutPlugin()` and `upgradeFAssetPair()` functions, and this, if used, will be the only case in which the pair functionalities may mutate (just once).
